/* =============================================================================
# Test Sprites

- Version: 1.4 (10/06/2025)
- Author: mvac7/303bcn
- Architecture: MSX
- Format: 16K ROM
- Programming language: C and Z80 assembler
- Compiler: SDCC 4.4 or newer

## Description:

Perform a test of the functions of the VDP SPRITE library for MSX ROM 
environment.
    
## History of versions (dd/mm/yyyy):
- v1.4 (10/06/2025) < Update to SDCC (4.1.12) Z80 calling conventions
- v1.3.1 (7/05/2019)
- v1.3 (30/04/2019) 
- v1.2 (19/04/2018) 
- v1.1 ( 2/03/2017)    
- v1.0 (25/02/2017) First version
============================================================================= */

#include "../include/newTypes.h"
#include "../include/msxBIOS.h"
#include "../include/msxSystemVariables.h"

#include "../include/VDP_TMS9918A_MSXBIOS.h"
#include "../include/VDP_SPRITES.h"




#define  HALT __asm halt __endasm   //wait for the next interrupt




//  definition of functions  ---------------------------------------------------
void WAIT(uint cicles);
char INKEY(void);

//void CLS(void);

void VPRINT(char column, char line, char* text);  //print in screen 1 or 2
void VPOKEARRAY(uint vaddr, char* text);

void LOCATE(char x, char y);
void PRINT(char* text);

char PEEK(uint address);

void setFont(void);

void setSpritesPatterns(void);
void showSprites(char offset);

void testSPRITES(void);
void testSpritePosition(void);
void testSpriteColor(void);
void testSpritePattern(void);
void testSpriteVisible(void);




// constants  ------------------------------------------------------------------

const char text01[] = "Test TMS9918A SPRITES Libraries";
const char text02[] = "Press any key";

const char sprcol[8]={12,3,10,15,6,11,9,14};

// ---------------------------------------------------------
// tMSgfX devtool v0.9.19.0
// Project: VDP_SPRITES
// Subproject: Examples
// Author: mvac7 - Group: 303bcn
// ---------------------------------------------------------
// SpriteSet Pattern Data - Size=16x16 - Mode=Mode1 Monocolor
// Sprite range: 0 to 9
// Size=320
const char SPRITE_PAT[]={
0x3C,0x42,0xA5,0x81,0xA5,0x99,0x42,0x3C,0x3C,0x7E,0xDB,0xFF,0xFF,0xDB,0x66,0x3C,
0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00,0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00,
0x10,0x38,0x54,0xFE,0x54,0x10,0x38,0x00,0x10,0x38,0x7C,0xFE,0xFE,0x10,0x38,0x00,
0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xE7,0xE7,0xFF,0xFF,0xFF,
0x0F,0x1F,0x3D,0x3F,0x7B,0x7C,0xBF,0xBF,0x9F,0xEF,0x6F,0x1F,0x0F,0x05,0x05,0x1D,
0xC0,0xE0,0x60,0xC0,0x40,0x80,0x80,0x84,0x86,0xDE,0xC0,0xC0,0x80,0x00,0x00,0xC0,
0x05,0x07,0x1A,0x2E,0x6F,0x5B,0x5C,0x5B,0x5F,0x58,0x6F,0x2D,0x16,0x02,0x02,0x06,
0x40,0xC0,0xB8,0xD4,0xD4,0x6A,0xEA,0x6A,0xEA,0x6A,0xD4,0xD4,0xF8,0x40,0x40,0x60,
0x03,0x07,0x4F,0xCF,0x4D,0x4F,0x2C,0x1E,0x3F,0x3F,0x3F,0x3F,0x1F,0x02,0x02,0x06,
0xC0,0xE2,0xE6,0xE2,0xA2,0xF4,0x38,0x7C,0xFE,0xFE,0xFE,0xFC,0xF8,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60,
0x05,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7D,0x7F,0x7F,0x78,0x3F,0x1F,0x04,0x04,0x0C,
0x40,0xC0,0xF0,0xF8,0xFC,0xFC,0xFC,0x7C,0xFC,0xFC,0x3C,0xF8,0xF0,0x40,0x40,0x60,
0x07,0x1F,0x3F,0x3F,0x7F,0x71,0x7F,0x7F,0x7F,0x7E,0x3E,0x3F,0x1F,0x07,0x02,0x06,
0xE0,0xF8,0xFC,0xFC,0xFE,0x8E,0xFE,0xFE,0xFE,0x7E,0x7C,0xFC,0xF8,0xE0,0x40,0x60,
0x00,0x07,0x1F,0x3F,0x7F,0x71,0xFF,0xFF,0x7B,0x7C,0x3F,0x1F,0x07,0x02,0x02,0x06,
0x00,0xE0,0xF8,0xFC,0xFE,0x8E,0xFF,0xFF,0xDE,0x3E,0xFC,0xF8,0xE0,0x40,0x40,0x60,
0x05,0x1E,0x3F,0x6F,0x57,0x6E,0x3F,0x00,0x07,0x05,0x07,0x04,0x06,0x03,0x02,0x06,
0x60,0xF8,0xF4,0xEA,0x76,0xBE,0x7C,0x00,0xE0,0x60,0xE0,0x20,0x60,0xC0,0x40,0x60};



// ByteniZ3R devtool v0.9.29.0-beta
// Project: VDP_SPRITES
// WF: Sine Unsigned Length=256 Min=16 Max=144 Phase=0 Freq=1
const char SIN[]={
0x50,0x52,0x53,0x55,0x56,0x58,0x59,0x5B,0x5D,0x5E,0x60,0x61,0x63,0x64,0x66,0x67,
0x69,0x6A,0x6B,0x6D,0x6E,0x70,0x71,0x72,0x74,0x75,0x76,0x78,0x79,0x7A,0x7B,0x7C,
0x7D,0x7E,0x80,0x81,0x82,0x83,0x84,0x84,0x85,0x86,0x87,0x88,0x89,0x89,0x8A,0x8B,
0x8B,0x8C,0x8C,0x8D,0x8D,0x8E,0x8E,0x8F,0x8F,0x8F,0x8F,0x90,0x90,0x90,0x90,0x90,
0x90,0x90,0x90,0x90,0x90,0x8F,0x8F,0x8F,0x8F,0x8E,0x8E,0x8E,0x8D,0x8D,0x8C,0x8C,
0x8B,0x8A,0x8A,0x89,0x88,0x87,0x87,0x86,0x85,0x84,0x83,0x82,0x81,0x80,0x7F,0x7E,
0x7D,0x7C,0x7B,0x79,0x78,0x77,0x76,0x74,0x73,0x72,0x70,0x6F,0x6E,0x6C,0x6B,0x69,
0x68,0x66,0x65,0x63,0x62,0x60,0x5F,0x5D,0x5C,0x5A,0x59,0x57,0x56,0x54,0x52,0x51,
0x4F,0x4E,0x4C,0x4A,0x49,0x47,0x46,0x44,0x43,0x41,0x40,0x3E,0x3D,0x3B,0x3A,0x38,
0x37,0x35,0x34,0x32,0x31,0x30,0x2E,0x2D,0x2C,0x2A,0x29,0x28,0x27,0x25,0x24,0x23,
0x22,0x21,0x20,0x1F,0x1E,0x1D,0x1C,0x1B,0x1A,0x19,0x19,0x18,0x17,0x16,0x16,0x15,
0x14,0x14,0x13,0x13,0x12,0x12,0x12,0x11,0x11,0x11,0x11,0x10,0x10,0x10,0x10,0x10,
0x10,0x10,0x10,0x10,0x10,0x11,0x11,0x11,0x11,0x12,0x12,0x13,0x13,0x14,0x14,0x15,
0x15,0x16,0x17,0x17,0x18,0x19,0x1A,0x1B,0x1C,0x1C,0x1D,0x1E,0x1F,0x20,0x22,0x23,
0x24,0x25,0x26,0x27,0x28,0x2A,0x2B,0x2C,0x2E,0x2F,0x30,0x32,0x33,0x35,0x36,0x37,
0x39,0x3A,0x3C,0x3D,0x3F,0x40,0x42,0x43,0x45,0x47,0x48,0x4A,0x4B,0x4D,0x4E,0x50};





char _LineLength;  //sprites per line. TMS9918=4; V9938=8



// Functions -------------------------------------------------------------------


//
void main(void)
{
  
//------------------------------------------------------------------------------   
	SCREEN(1);
	CLS();

	VPRINT(0,0,text01);
	VPRINT(0,1,"Graphic1 (SCREEN 1)");
	_LineLength=4; 
	testSPRITES();


  
//---------------------------------------------------------------------only MSX2
/*  if (PEEK(MSXVER)>0)
  {
    SCREEN(4);  //G4 V9938 mode
    CLS();
    setFont();  
    
    VPRINT(0,0,"Graphic3 (SCREEN 4)");
    
    _LineLength=8; 
    testSPRITES();  
  }*/  
//------------------------------------------------------------------------------  
  

  
//END --------------------------------------------------------------------------  
  
	//COLOR(15,4,4);
	SCREEN(1);

	VPRINT(0,0,"End of the test...");
	WAIT(30*10);
  
}




/* =============================================================================
One character input (waiting)
============================================================================= */
char INKEY(void) __naked
{
__asm
    
	jp BIOS_CHGET

__endasm;
}



// Generates a pause in the execution of n interruptions.
// PAL: 50=1second. ; NTSC: 60=1second. 
void WAIT(uint cicles)
{
	uint i;
	for(i=0;i<cicles;i++) HALT;
}



//print in screen 1 or 2
void VPRINT(char column, char line, char* text)
{
	uint vaddr = BASE10 + (line*32)+column; // calcula la posicion en la VRAM
	VPOKEARRAY(vaddr, text);
}



void VPOKEARRAY(uint vaddr, char* text)
{
	while(*(text)) VPOKE(vaddr++,*(text++));
}



/* =============================================================================
LOCATE
Description: 
	   Moves the cursor to the specified location.
	   
Input:	[char] Position X of the cursor. TEXT 1 (0 to 39) 
										TEXT 2 (0 to 79)
										GRAPHIC 1 (0 to 31)
		[char] Position Y of the cursor. (0 to 23)         
Output:	-
============================================================================= */
void LOCATE(char x, char y) __naked
{
x;
y;
__asm

	inc  A
	ld   H,A

	inc  L

	jp   BIOS_POSIT

__endasm;
}



/* =============================================================================
   Print a text in screen
============================================================================= */
void PRINT(char* text) __naked
{ 
text;
__asm
  
nextCHAR:  
	ld   A,(HL)
	or   A
	ret   Z
	call BIOS_CHPUT //Displays one character (BIOS)
	inc  HL
	jr   nextCHAR

__endasm; 
}



char PEEK(uint address) __naked
{
address;
__asm
	ld   A,(HL)
	ret  
__endasm;
}



void setFont(void)
{
	uint ROMfont = *(unsigned int *) CGTABL;

	CopyToVRAM(ROMfont,G2_PAT_A,0x800);	//MSX font pattern
	CopyToVRAM(ROMfont,G2_PAT_B,0x800);	//MSX font pattern
	CopyToVRAM(ROMfont,G2_PAT_C,0x800);	//MSX font pattern
	FillVRAM(G2_COL,0x1800,0xF4);			//colors
}




// TEST SPRITES  ###############################################################
void testSPRITES(void)
{
	char posY=2;

	setSpritesPatterns();
	VPRINT(0,posY++, "----------VDP_TMS9918A Functions");

	// sprites 8x8
	VPRINT(0,posY++, "SetSpritesSize(0) SPRITES 8x8");
	SetSpritesSize(0);
	SetSpritesZoom(false);  
	showSprites(0);
	WAIT(50);

	// test sprites 16x16
	VPRINT(0,posY++, "SetSpritesSize(1) SPRITES 16x16");
	SetSpritesSize(1);
	showSprites(2);
	WAIT(50);

	// test sprites 16x16 + zoom  
	VPRINT(0,posY++, "SetSpritesZoom(true) SPRITES x2");
	SetSpritesZoom(true);
	WAIT(50);

	//test clear sprites data
	VPRINT(0,posY++, "ClearSprites()");
	ClearSprites();
	WAIT(100);

	setSpritesPatterns();
	VPRINT(0,posY++, "PUTSPRITE(plane,x,y,color,nSPR)");
	showSprites(2);

	WAIT(50);
	posY++;  
	VPRINT(0,posY++, "-----------VDP_SPRITES Functions");

	VPRINT(0,posY++, "SetSpriteVisible(plane,state)");
	testSpriteVisible();

	VPRINT(0,posY++, "SetSpritePattern(plane,nSPR)"); 
	testSpritePattern();

	VPRINT(0,posY++, "SetSpriteColor(plane,color)"); 
	testSpriteColor();

	VPRINT(0,posY++, "SetSpritePosition(plane,x,y)");
	testSpritePosition();

	WAIT(50);

	VPRINT(0,posY++, "SetEarlyClock(plane)");
	SetEarlyClock(7);
	WAIT(50);

	VPRINT(0,posY++, "Set Color with EarlyClock"); 
	SetSpriteColor(7, 7);
	WAIT(50);

	VPRINT(0,posY++, "UnsetEarlyClock(plane)");
	UnsetEarlyClock(7);
	WAIT(50);

	posY+=3;
	VPRINT(0,posY, text02);
	LOCATE(14,posY);
	INKEY();
}




// Copy sprites data from memory to VRAM
void setSpritesPatterns(void)
{
	HALT;
	CopyToVRAM((uint) SPRITE_PAT,BASE14,32*10);
}



// TEST PUTSPRITE  #############################################################
void showSprites(char offset)
{
	char X=0,Y=3;
	char i=0;

	for(i=0;i<8;i++)
	{
		PUTSPRITE(i, X*32, Y*32, sprcol[i], i+offset);
		X++;
		if(X==_LineLength)
		{
			X=0;
			Y++;
		}
	}
}



// TEST SETSPRITEVISIBLE  ######################################################
void testSpriteVisible(void)
{
	char i,o;

	SetSpriteVisible(0,false);

	for(i=0;i<8;i++)
	{
		for(o=0;o<8;o++)
		{
			if (o==i) SetSpriteVisible(o,true);
			else SetSpriteVisible(o,false);  
		}
		WAIT(25);  
	}  
}





// TEST SETSPRITEPATTERN  ######################################################
void testSpritePattern(void)
{
	char i;

	for(i=2;i<10;i++)
	{
		SetSpritePattern(7, i);
		WAIT(25);  
	}  
}



// TEST SETSPRITECOLOR  ########################################################
void testSpriteColor(void)
{
	char i;

	for(i=0;i<16;i++)
	{
		SetSpriteColor(7, i);
		WAIT(25);  
	}  
}



// TEST SETSPRITEPOSITION  #####################################################
void testSpritePosition(void)
{
	uint i=0;
	char gradX = 64;
	char gradY = 0;
	
	SetSpriteColor(7, 14);

	for(i=0;i<660;i++)
	{
		HALT;
		SetSpritePosition(7, SIN[gradX], SIN[gradY]);
		gradX++;
		gradY++;
		//if(posT>255) posT=0;  
	}
}








